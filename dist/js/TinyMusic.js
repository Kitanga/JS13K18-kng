(function(t,e){"function"==typeof define&&define.amd?define(["exports"],e):e("object"==typeof exports&&"string"!=typeof exports.nodeName?exports:t.TinyMusic={})})(this,function(t){function e(t){var s=t.split(r);this.frequency=e.getFrequency(s[0])||0,this.duration=e.getDuration(s[1])||0}function s(t,e,s){this.ac=t||new AudioContext,this.createFxNodes(),this.tempo=e||120,this.loop=!0,this.smoothing=0,this.staccato=0,this.notes=[],this.push.apply(this,s||[]),this.pulseWidth=this.ac.createGain()}var i="B#-C|C#-Db|D|D#-Eb|E-Fb|E#-F|F#-Gb|G|G#-Ab|A|A#-Bb|B-Cb",n=440*Math.pow(Math.pow(2,1/12),-9),o=/^[0-9.]+$/,c=4,r=/\s+/,a=/(\d+)/,h={};i.split("|").forEach(function(t,e){t.split("-").forEach(function(t){h[t]=e})}),e.getFrequency=function(t){var e=t.split(a),s=h[e[0]],i=(e[1]||c)-c,o=n*Math.pow(Math.pow(2,1/12),s);return o*Math.pow(2,i)},e.getDuration=function(t){return o.test(t)?parseFloat(t):t.toLowerCase().split("").reduce(function(t,e){return t+("w"===e?4:"h"===e?2:"q"===e?1:"e"===e?.5:"s"===e?.25:0)},0)},s.prototype.createFxNodes=function(t){var e=[["bass",100],["mid",1e3],["treble",2500]],s=this.gain=t||this.ac.createGain();return e.forEach(function(t,e){e=this[t[0]]=this.ac.createBiquadFilter(),e.type="peaking",e.frequency.value=t[1],s.connect(s=e)}.bind(this)),s.connect(this.ac.destination),this},s.prototype.push=function(){return Array.prototype.forEach.call(arguments,function(t){this.notes.push(t instanceof e?t:new e(t))}.bind(this)),this},s.prototype.createCustomWave=function(t,e){e||(e=t),this.waveType="custom",this.customWave=[new Float32Array(t),new Float32Array(e)]},s.prototype.createOscillator=function(){return this.stop(),this.osc=this.ac.createOscillator(),"pulse"===this.waveType?this.osc=this.createPulseOscillator():this.customWave?this.osc.setPeriodicWave(this.ac.createPeriodicWave.apply(this.ac,this.customWave)):this.osc.type=this.waveType||"square",this.osc.connect(this.gain),this},s.prototype.createPulseOscillator=function(){for(var t=new Float32Array(256),e=0;e<128;e++)t[e]=-1,t[e+128]=1;var s=new Float32Array(2);s[0]=.5,s[1]=.5;var i=this.ac.createOscillator();i.type="sawtooth";var n=this.ac.createWaveShaper();n.curve=t,i.connect(n);var o=this.pulseWidth;i.width=o.gain,o.connect(n);var c=this.ac.createWaveShaper();return c.curve=s,i.connect(c),c.connect(o),i.connect=function(){n.connect.apply(n,arguments)},i._disconnect=i.disconnect.bind(i),i.disconnect=function(){n.disconnect.apply(n,arguments)},i},s.prototype.scheduleNote=function(t,e){var s=60/this.tempo*this.notes[t].duration,i=s*(1-(this.staccato||0));return this.setFrequency(this.notes[t].frequency,e),this.smoothing&&this.notes[t].frequency&&this.slide(t,e,i),this.setFrequency(0,e+i),e+s},s.prototype.getNextNote=function(t){return this.notes[t<this.notes.length-1?t+1:0]},s.prototype.getSlideStartDelay=function(t){return t-Math.min(t,60/this.tempo*this.smoothing)},s.prototype.slide=function(t,e,s){var i=this.getNextNote(t),n=this.getSlideStartDelay(s);return this.setFrequency(this.notes[t].frequency,e+n),this.rampFrequency(i.frequency,e+s),this},s.prototype.setFrequency=function(t,e){return this.osc.frequency.setValueAtTime(t,e),this},s.prototype.rampFrequency=function(t,e){return this.osc.frequency.linearRampToValueAtTime(t,e),this},s.prototype.play=function(t){return t="number"==typeof t?t:this.ac.currentTime,this.createOscillator(),this.osc.start(t),this.notes.forEach(function(e,s){t=this.scheduleNote(s,t)}.bind(this)),this.osc.stop(t),this.osc.onended=this.loop?this.play.bind(this,t):null,this},s.prototype.stop=function(){return this.osc&&(this.osc.onended=null,this.osc._disconnect&&this.osc._disconnect(),this.osc.disconnect(),this.osc=null),this},t.Note=e,t.Sequence=s});